<div class="container py-4" data-controller="admin-rooms-calendar-toggle">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Chambres</h1>
    <%= link_to "Nouvelle chambre", new_admin_room_path, class: "btn btn-primary" %>
  </div>

  <div class="lv-calendar-legend text-muted mb-3">
    <span><span class="lv-calendar-dot lv-calendar-dot--open"></span>Ouvert</span>
    <span><span class="lv-calendar-dot lv-calendar-dot--pending"></span>Demande (à approuver)</span>
    <span><span class="lv-calendar-dot lv-calendar-dot--booked"></span>Réservé (en attente/payé)</span>
  </div>

  <div class="d-flex flex-wrap gap-3 align-items-center mb-3">
    <% if @rooms.size > 1 %>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" role="switch" id="lv-toggle-combined" checked
               data-admin-rooms-calendar-toggle-target="combinedToggle"
               data-action="change->admin-rooms-calendar-toggle#toggleCombined">
        <label class="form-check-label" for="lv-toggle-combined">Afficher la vue combinée</label>
      </div>
    <% end %>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="lv-toggle-per-room" checked
             data-admin-rooms-calendar-toggle-target="perRoomToggle"
             data-action="change->admin-rooms-calendar-toggle#togglePerRoom">
      <label class="form-check-label" for="lv-toggle-per-room">Afficher les calendriers par chambre</label>
    </div>
  </div>

  <% if @rooms.size >= 2 %>
    <div class="card mb-4" data-admin-rooms-calendar-toggle-target="combined">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center gap-3">
          <div>
            <div class="fw-semibold">Disponibilités communes (toutes les chambres)</div>
            <small class="text-muted">Vert = ouvert pour toutes les chambres. Jaune = demande. Rouge = au moins une chambre réservée.</small>
          </div>
          <span class="badge text-bg-secondary"><%= @rooms.size %> chambres</span>
        </div>

        <div class="mt-3">
          <input type="text" class="lv-calendar-input" data-controller="admin-room-calendar"
                 data-admin-room-calendar-open-ranges-value="<%= (@combined_open_ranges || []).to_json %>"
                 data-admin-room-calendar-booked-ranges-value="<%= (@combined_booked_ranges || []).to_json %>"
                 data-admin-room-calendar-pending-ranges-value="<%= (@combined_pending_ranges || []).to_json %>" />
        </div>
      </div>
    </div>
  <% end %>

  <% if @rooms.empty? %>
    <p class="text-muted">Aucune chambre pour le moment.</p>
  <% else %>
    <div class="row g-3">
      <% @rooms.each do |room| %>
        <% open_ranges = room.opening_periods.sort_by(&:start_date).map { |p| { from: p.start_date, to: (p.end_date - 1.day) } } %>
        <% booked_ranges = room.bookings.select { |b| Booking::RESERVED_STATUSES.include?(b.status) }.sort_by(&:start_date).map { |b| { from: b.start_date, to: (b.end_date - 1.day) } } %>
        <% pending_ranges = room.bookings.select { |b| b.status == "requested" }.sort_by(&:start_date).map { |b| { from: b.start_date, to: (b.end_date - 1.day) } } %>

        <div class="col-12 col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div>
                  <div class="fw-bold"><%= link_to room.name, admin_room_path(room), class: "text-decoration-none" %></div>
                  <% if room.capacity.present? %>
                    <small class="text-muted">Capacité : <%= room.capacity %></small>
                  <% end %>
                </div>
                <div class="d-flex gap-2">
                  <%= link_to "Modifier", edit_admin_room_path(room), class: "btn btn-sm btn-outline-primary" %>
                  <%= button_to "Supprimer",
                        admin_room_path(room),
                        method: :delete,
                        form: {
                          data: {
                            controller: "confirm-delete",
                            action: "submit->confirm-delete#confirm",
                            "confirm-delete-message-value": "Attention, supprimer cette chambre détruira définitivement toutes les informations et réservations passées et à venir la concernant. Etes-vous sûr ?",
                            "confirm-delete-cancel-text-value": "Annuler",
                            "confirm-delete-confirm-text-value": "Supprimer"
                          }
                        },
                        class: "btn btn-sm btn-outline-danger" %>
                </div>
              </div>

              <div class="mt-3" data-admin-rooms-calendar-toggle-target="perRoomCalendar">
                <input type="text" class="lv-calendar-input" data-controller="admin-room-calendar"
                       data-admin-room-calendar-open-ranges-value="<%= open_ranges.to_json %>"
                       data-admin-room-calendar-booked-ranges-value="<%= booked_ranges.to_json %>"
                       data-admin-room-calendar-pending-ranges-value="<%= pending_ranges.to_json %>" />
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
