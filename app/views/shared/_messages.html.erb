<% is_me_for = lambda do |message|
  if current_owner.present?
    message.sender_type == "Owner" && message.sender_id == current_owner.id
  elsif current_user.present?
    message.sender_type == "User" && message.sender_id == current_user.id
  else
    false
  end
end %>

<% sender_label_for = lambda do |message|
  if is_me_for.call(message)
    t("messages.sender.me")
  elsif message.sender_type == "Owner"
    t("messages.sender.host")
  else
    sender = message.sender
    if sender.is_a?(User)
      full_name = [sender.first_name, sender.last_name].map { |s| s.to_s.strip.presence }.compact.join(" ").presence
      full_name || t("messages.sender.traveler")
    else
      t("messages.sender.traveler")
    end
  end
end %>

<% rendered_messages = messages.map do |m|
  {
    sender: sender_label_for.call(m),
    body: m.body,
    created_at: l(m.created_at.in_time_zone, format: :short),
    css_class: (is_me_for.call(m) ? "lv-message--me" : "lv-message--other")
  }
end %>

<% composer_position = (local_assigns[:composer_position] || :bottom).to_sym %>
<% scroll_behavior = (local_assigns[:scroll_behavior] || :bottom).to_sym %>

<div class="lv-thread">
  <% if composer_position == :top %>
    <div class="lv-thread__composer">
      <%= form_with model: [booking, Message.new], url: booking_messages_path(booking_id: booking), method: :post,
        data: { controller: "form-submit", action: "submit->form-submit#lock" } do |f| %>
        <div class="mb-2">
          <%= f.label :body, t("messages.composer.label"), class: "form-label" %>
          <%= f.text_area :body, class: "form-control lv-composer__textarea", placeholder: t("messages.composer.placeholder") %>
        </div>
        <div class="d-flex justify-content-end">
          <%= f.submit t("shared.actions.send"), class: "btn btn-primary", data: { "form-submit-target": "button" } %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="lv-thread__scroll" <%= scroll_behavior == :bottom ? 'data-controller="scroll-to-bottom"'.html_safe : "" %>>
    <div
      data-controller="mustache-messages"
      data-mustache-messages-messages-value="<%= ERB::Util.json_escape(rendered_messages.to_json) %>">
      <script type="text/template" data-mustache-messages-target="template">
        <div class="d-flex flex-column gap-3">
          {{#messages}}
            <div class="lv-message {{css_class}}">
              <div class="lv-message__meta">
                <span class="lv-message__sender">{{sender}}</span>
                <span>Â·</span>
                <span>{{created_at}}</span>
              </div>
              <div class="lv-bubble">
                <p class="lv-message__body">{{body}}</p>
              </div>
            </div>
          {{/messages}}
        </div>
      </script>

      <div data-mustache-messages-target="list">
        <div class="d-flex flex-column gap-3">
          <% messages.each do |message| %>
            <% css_class = is_me_for.call(message) ? "lv-message--me" : "lv-message--other" %>
            <div class="lv-message <%= css_class %>">
              <div class="lv-message__meta">
                <span class="lv-message__sender"><%= sender_label_for.call(message) %></span>
                <span>Â·</span>
                <span><%= l(message.created_at.in_time_zone, format: :short) %></span>
              </div>
              <div class="lv-bubble">
                <p class="lv-message__body"><%= message.body %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <% if composer_position != :top %>
    <div class="lv-thread__composer">
      <%= form_with model: [booking, Message.new], url: booking_messages_path(booking_id: booking), method: :post,
        data: { controller: "form-submit", action: "submit->form-submit#lock" } do |f| %>
        <div class="mb-2">
          <%= f.label :body, t("messages.composer.label"), class: "form-label" %>
          <%= f.text_area :body, class: "form-control lv-composer__textarea", placeholder: t("messages.composer.placeholder") %>
        </div>
        <div class="d-flex justify-content-end">
          <%= f.submit t("shared.actions.send"), class: "btn btn-primary", data: { "form-submit-target": "button" } %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
