<h2>Messages</h2>

<% sender_label_for = lambda do |message|
  if current_owner.present? && message.sender_type == "Owner" && message.sender_id == current_owner.id
    "Vous"
  elsif current_user.present? && message.sender_type == "User" && message.sender_id == current_user.id
    "Vous"
  elsif message.sender_type == "Owner"
    "HÃ´te"
  else
    "Voyageur"
  end
end %>

<% rendered_messages = messages.map do |m|
  {
    sender: sender_label_for.call(m),
    body: m.body,
    created_at: m.created_at.to_s
  }
end %>

<div
  data-controller="mustache-messages"
  data-mustache-messages-messages-value="<%= ERB::Util.json_escape(rendered_messages.to_json) %>">
  <script type="text/template" data-mustache-messages-target="template">
    <ul>
      {{#messages}}
        <li>
          <strong>{{sender}}:</strong>
          {{body}}
          <small>({{created_at}})</small>
        </li>
      {{/messages}}
    </ul>
  </script>

  <div data-mustache-messages-target="list">
    <ul>
      <% messages.each do |message| %>
        <li>
          <strong><%= sender_label_for.call(message) %>:</strong>
          <%= message.body %>
          <small>(<%= message.created_at %>)</small>
        </li>
      <% end %>
    </ul>
  </div>
</div>

<%= form_with model: [booking, Message.new], url: booking_messages_path(booking), method: :post do |f| %>
  <div class="mb-3">
    <%= f.label :body, "New message" %>
    <%= f.text_area :body, class: "form-control" %>
  </div>
  <%= f.submit "Send", class: "btn btn-primary" %>
<% end %>
