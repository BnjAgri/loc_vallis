<div class="banner">
  <div class="container">
    <h1>Bienvenue chez <strong>Claude</strong> à <strong>Anglès</strong>!</h1>
    <p>Maison et chambres d'hôtes sur la route de Saint Jacques de Compostelle</p>
    <%= link_to "Réservation", rooms_path, class: "btn btn-flat" %>
  </div>
</div>

<h1>Hébergements</h1>

<div class="container mt-4">
  <div class="row g-3">
    <% @rooms.each do |room| %>
      <% image_url = if room.photos.attached?
        url_for(room.photos.first)
      elsif room.image_urls.any?
        room.image_urls.first
      else
        "https://raw.githubusercontent.com/lewagon/fullstack-images/master/uikit/breakfast.jpg"
      end %>

      <% min_period = room.opening_periods.min_by(&:nightly_price_cents) %>

      <div class="col-12 col-md-6 col-lg-4">
        <%= link_to room_path(room), class: "text-decoration-none" do %>
          <div class="bg-white">
            <div
              class="card-category"
              style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('<%= image_url %>')"
            >
              <%= room.name %>
            </div>

            <div class="p-2">
              <% if room.capacity.present? %>
                <div class="text-muted">Capacité : <%= room.capacity %> pers.</div>
              <% end %>

              <% if min_period.present? %>
                <div>
                  À partir de
                  <%= number_to_currency(min_period.nightly_price_cents / 100.0, unit: "#{min_period.currency.upcase} ", format: "%u%n") %>
                  par nuit
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% mapbox_access_token = ENV["MAPBOX_ACCESS_TOKEN"].to_s %>
<% map_address = ENV.fetch("MAP_ADDRESS", "Anglès, France") %>
<% map_lat = ENV.fetch("MAP_LAT", "43.5644").to_f %>
<% map_lng = ENV.fetch("MAP_LNG", "2.5617").to_f %>

<div class="container mt-4">
  <div class="card-category p-0" style="height: 320px; display: block;">
    <% if mapbox_access_token.present? %>
      <div
        data-controller="mapbox"
        data-mapbox-access-token-value="<%= mapbox_access_token %>"
        data-mapbox-lat-value="<%= map_lat %>"
        data-mapbox-lng-value="<%= map_lng %>"
        data-mapbox-zoom-value="13"
        data-mapbox-interactive-value="true"
        data-mapbox-animate-zoom-value="true"
        data-mapbox-animate-duration-ms-value="2000"
        style="height: 100%; width: 100%;"
      ></div>
    <% else %>
      <div class="h-100 w-100 d-flex align-items-center justify-content-center bg-white text-muted">
        MAPBOX_ACCESS_TOKEN manquant
      </div>
    <% end %>
  </div>
  <div class="mt-2 text-muted"><strong>Adresse :</strong> <%= map_address %></div>
</div>
